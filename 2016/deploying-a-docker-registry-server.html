<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <link href="http://gmpg.org/xfn/11" rel="profile">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>在 CentOS 7 上搭建 Docker 私有仓库 - 肉山·察</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	
	<link rel="canonical" href="http://roshanca.com/2016/deploying-a-docker-registry-server">
	<link rel="alternate" type="application/rss+xml" title="Subscribe Feed" href="/feed.xml">
	<link  href="/css/app.css" rel="stylesheet" media="all">
	<link href="//cdn.bootcss.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='//fonts.useso.com/css?family=PT+Serif:400,700' rel='stylesheet' type='text/css'>
	<script>
	function loadSync(u,p,a){
		if(!p && location.port)return {onload: null};
		if(/\.js$/.test(u)){a='script'}else{a='link'};
		var d=document,s=d.createElement(a),f=d.getElementsByTagName(a)[0];
		if(a=='link'){s.href=u,s.rel='stylesheet'}else{s.src=u,s.async=true}
		f.parentNode.insertBefore(s,f);return s;
	}
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-15720258-1']);
	_gaq.push(['_trackPageview']);
	_gaq.push(['_trackPageLoadTime']);
	loadSync('//ssl.google-analytics.com/ga.js');
	if(/windows/i.test(navigator.userAgent)){document.getElementsByTagName('html')[0].className = 'windows'}
    </script>
    <!--[if lt IE 9]>
    <script>window.location.href="http://browsehappy.com"</script>
    <![endif]-->
</head>

<body>

<header id="header" role="banner">
	<div class="header-inner">
	
		<a href="/" class="blog-title home">肉山·察</a>
		<div>
	<a href="//github.com/roshanca" class="social-link">
		<i class="fa fa-github"></i>
	</a>

	<a href="//twitter.com/roshan_wu" class="social-link">
		<i class="fa fa-twitter"></i>
	</a>

	<a href="//weibo.com/jinfeixibi" class="social-link">
		<i class="fa fa-weibo"></i>
	</a>

	<a href="//www.flickr.com/photos/roshanca/" class="social-link">
		<i class="fa fa-flickr"></i>
	</a>
</div>
	
	</div>
	<a href="/feed.xml" data-tip="true" data-tip-content="订阅" class="tip--top subscribe">
		<i class="fa fa-rss"></i>
	</a>
</header>

<main class="fluid" role="main">
  <article class="post" role="article">
    <header class="post-header">
      <h1 class="post-title">在 CentOS 7 上搭建 Docker 私有仓库</h1>
    </header>
    <section class="post-content">
      <p>我们知道，执行 docker pull 某镜象，默认都是从 <a href="https://hub.docker.com/">Docker Hub</a> 的公共仓库去获取的。这有点像全球最大的代码托管商：Github，但对于公司而言，也行我们更加需要是的自建的仓库服务，所以我们用自建的 Gitlab 代替 Github，那有什么可以替代 Docker Hub 呢？答案是：自建 Docker Registry。以下是自己的一点实践：</p>

<h2>安装环境</h2>

<p>docker-engine 使用了最新的 1.11.2 版本。</p>
<div class="highlight"><pre><code class="language-" data-lang="">[root@crh211 ~]# docker version
Client:
 Version:      1.11.2
 API version:  1.23
 Go version:   go1.5.4
 Git commit:   b9f10c9
 Built:        Wed Jun  1 21:23:11 2016
 OS/Arch:      linux/amd64

Server:
 Version:      1.11.2
 API version:  1.23
 Go version:   go1.5.4
 Git commit:   b9f10c9
 Built:        Wed Jun  1 21:23:11 2016
 OS/Arch:      linux/amd64
</code></pre></div>
<p>操作系统采用 CentOS 7, 内核 <code>3.10.0-229.el7.x86_64</code></p>

<h2>Docker Registry</h2>

<p>一开始照着 <a href="https://yeasy.gitbooks.io/docker_practice/content/repository/local_repo.html">这里</a> 的教程安装了一下，发现在 push 镜象时，会报错。应该是跟 <code>https</code> 相关的问题，查阅了一下 <a href="https://docs.docker.com/registry/insecure/">官方资料</a>，依照提示想给 docker 启动增加参数：</p>
<div class="highlight"><pre><code class="language-" data-lang="">DOCKER_OPTS="--insecure-registry myregistrydomain.com:5000"
</code></pre></div>
<p>但重启 docker 后好像没反应，试了好多种类似的方案都不行。看来要换种思路。一路找下去找到了 Docker Registry 2.0，抛弃了 insecure 的运行方式，而是采用了自建证书的认证方式。</p>

<h3>生成证书</h3>
<div class="highlight"><pre><code class="language-" data-lang="">mkdir -p certs &amp;&amp; openssl req \
  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \
  -x509 -days 365 -out certs/domain.crt

Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Zhengjiang
Locality Name (eg, city) []:Hangzhou
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Cairenhui
Organizational Unit Name (eg, section) []:FE
Common Name (e.g. server FQDN or YOUR name) []:192.168.1.211:5000
Email Address []:wuwj@cairenhui.com  
</code></pre></div>
<p>接下来将刚生成的 <code>certs/domain.crt</code> 复制到 <code>/etc/docker/certs.d/192.168.1.211:5000/ca.crt</code>，并<strong>重启 docker</strong>。</p>

<h3>安装 Docker Registry 2.0</h3>
<div class="highlight"><pre><code class="language-" data-lang="">docker run -d -p 5000:5000 --restart=always --name registry \
  -v /root/certs:/certs \
  -v /opt/data:/var/lib/registry \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2
</code></pre></div>
<h2>问题</h2>

<p>安装完后在 push 镜象时还是遇到了一点小问题：</p>
<div class="highlight"><pre><code class="language-" data-lang="">x509: cannot validate certificate for 192.168.1.211 because it doesn't contain any IP SANs
</code></pre></div>
<h3>解决办法：</h3>

<p>修改 <code>/etc/pki/tls/openssl.cnf</code> 配置，在该文件中找到 <code>[ v3_ca ]</code>，在它下面添加如下内容：</p>
<div class="highlight"><pre><code class="language-" data-lang="">[ v3_ca ]
# Extensions for a typical CA
subjectAltName = IP:192.168.1.211
</code></pre></div>
<p>再次重启 docker，问题解决。</p>

<p>至此，<code>docker registry</code> 私有仓库安装成功。
接下来可以随时登录公司的 VPN 去 pull 镜象了，正式登上 docker 这艘大船初步探入云时代了。</p>

    </section>
    <footer class="post-footer">
      <div class="post-meta">
        <time datetime="2016-07-24 00:00:00 +0000" class="updated" pubdate>Jul 24, 2016</time>

        
<span class="post-tag">
	
		<span class="tag">docker</span>
	
</span>


      </div>
    </footer>
  </article>
</main>

<div class="post-comment">
	<div id="disqus_thread" class="container"></div>
</div>
<script>
function getElementTopLeft(elem) {
	var top = 0;
	var left = 0;
	while(elem) {
		top += elem.offsetTop;
		left += elem.offsetLeft;

		elem = elem.offsetParent;
	}
	return {top: top, left: left};
}

var disqus_shortname = 'roshanca';
var disqus_elem = document.getElementById('disqus_thread');
var disqus_init = false;

window.onscroll = function () {
	if (disqus_init) return;

	var viewHeight = document.documentElement.clientHeight;
	var scrollY = document.documentElement.scrollTop || document.body.scrollTop;

	if(getElementTopLeft(disqus_elem).top < viewHeight + scrollY) {
		loadSync('//' + disqus_shortname + '.disqus.com/embed.js');
		disqus_init = true;
	}
}
</script>



<footer id="footer" role="contentinfo">
	<p>© Copyright 2012 - 2017 by Roshan Wu.</p>
</footer>

<div class="fork-github">
    <a href="https://github.com/roshanca/blog">View on GitHub</a>
</div>

</body>
</html>

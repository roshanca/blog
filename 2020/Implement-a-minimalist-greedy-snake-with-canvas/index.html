<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡ - è‚‰å±±Â·å¯Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡ | è‚‰å±±Â·å¯Ÿ</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡" />
<meta property="og:locale" content="zh_Hans" />
<meta name="description" content="å‰è¨€" />
<meta property="og:description" content="å‰è¨€" />
<link rel="canonical" href="https://roshanca.com/2020/Implement-a-minimalist-greedy-snake-with-canvas/" />
<meta property="og:url" content="https://roshanca.com/2020/Implement-a-minimalist-greedy-snake-with-canvas/" />
<meta property="og:site_name" content="è‚‰å±±Â·å¯Ÿ" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-20T15:43:09+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡" />
<meta name="twitter:site" content="@roshan_wu" />
<meta name="twitter:creator" content="@roshan_wu" />
<script type="application/ld+json">
{"datePublished":"2020-05-20T15:43:09+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://roshanca.com/2020/Implement-a-minimalist-greedy-snake-with-canvas/"},"description":"å‰è¨€","@type":"BlogPosting","url":"https://roshanca.com/2020/Implement-a-minimalist-greedy-snake-with-canvas/","headline":"ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡","dateModified":"2020-05-20T15:43:09+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link href="/assets/styles/main.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="preload" href="//cdn.bootcss.com/font-awesome/4.1.0/fonts/fontawesome-webfont.woff?v=4.1.0" as="font" crossorigin><link type="application/atom+xml" rel="alternate" href="https://roshanca.com/feed.xml" title="è‚‰å±±Â·å¯Ÿ" /><script>
    function loadSync(u,p,a){
      if(!p && location.port)return {onload: null};
      if(/\.js$/.test(u)){a='script'}else{a='link'};
      var d=document,s=d.createElement(a),f=d.getElementsByTagName(a)[0];
      if(a=='link'){s.href=u,s.rel='stylesheet'}else{s.src=u,s.async=true}
      f.parentNode.insertBefore(s,f);return s;
    }
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15720258-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackPageLoadTime']);
    loadSync('//ssl.google-analytics.com/ga.js');
    if(/windows/i.test(navigator.userAgent)){document.getElementsByTagName('html')[0].className = 'windows'}
  </script>
  <!--[if lt IE 9]>
  <script>window.location.href="//browsehappy.com"</script>
  <![endif]-->
</head>

<body>
<header id="header" role="banner">
  
  <div class="header-inner">
    <a href="/" class="blog-title home">è‚‰å±±Â·å¯Ÿ</a>
    
    <div class="post-title">ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡</div>
    
    <div class="header-icon">
<a href="//github.com/roshanca" class="social-link">
  <i class="fa fa-github"></i>
  <span hidden>github</span>
</a>

<a href="//twitter.com/roshan_wu" class="social-link">
  <i class="fa fa-twitter"></i>
  <span hidden>twitter</span>
</a>

<a href="//www.instagram.com/roshanca/" class="social-link">
  <i class="fa fa-instagram"></i>
  <span hidden>instagram</span>
</a>

<a href="/feed.xml" class="social-link">
  <i class="fa fa-rss"></i>
  <span hidden>rss</span>
</a>

</div>
  </div>
  <a href="/" class="author">
    <span hidden>è‚‰å±±Â·å¯Ÿ</span>
  </a>
  
</header>

<div class="scroll-view">
  <main class="fluid" role="main">
  <article class="post" role="article">
    <header class="post-header">
      <h1 class="post-title">ç”¨ Canvas å®ç°ä¸€ä¸ªæç®€è´ªé£Ÿè›‡</h1>
    </header>
    <section class="post-content">
      <nav class="post-toc">
        <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#å‰è¨€">å‰è¨€</a></li>
<li class="toc-entry toc-h2"><a href="#ç”»è›‡ä¸æ·»è¶³">ç”»è›‡ä¸æ·»è¶³</a></li>
<li class="toc-entry toc-h2"><a href="#direction">direction</a></li>
<li class="toc-entry toc-h2"><a href="#æ¡ä»¶åˆ¤æ–­">æ¡ä»¶åˆ¤æ–­</a></li>
<li class="toc-entry toc-h2"><a href="#iife">IIFE</a></li>
</ul>
        <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
          <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round"
            transform="translate(-0.5, -0.5)" />
        </svg>
      </nav>
      <h2 id="å‰è¨€">
<a class="anchor" href="#%E5%89%8D%E8%A8%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>å‰è¨€</h2>

<p>ç¬”è€…æ›¾ç»åœ¨å­¦ä¹  TS æ—¶å†™è¿‡ä¸€ä¸ª<a href="/2015/write-a-simple-snake-game-with-typescript/">è´ªé£Ÿè›‡å°æ¸¸æˆ</a>ï¼Œä½†é‚£æ˜¯åŸºäº DOM çš„ï¼Œä»£ç è¾ƒä¸ºå•°å”†ï¼ˆæ¯•ç«Ÿæ˜¯ç”¨æ¥å­¦ä¹ åŸºäºé™æ€ç±»å‹çš„ TSï¼‰ã€‚è¿™æ¬¡æ— æ„é—´çœ‹è§ç½‘ä¸ŠæŸä½é«˜äººå†™çš„è´ªé£Ÿè›‡å°æ¸¸æˆï¼Œå¯¥å¯¥å‡ è¡Œä»£ç æå®šï¼Œå¹ä¸ºè§‚æ­¢ã€‚åˆçœ‹ä»£ç ï¼Œæ˜¯å¾ˆå¤§ç¨‹åº¦åœ°åˆ©ç”¨äº† JS å¼±è¯­è¨€çš„çµæ´»åº¦ï¼Œä»¥å°‘é‡ä»£ç åšäº†å¤§é‡çš„å·¥ä½œï¼Œæ˜¯çœŸæ­£ä½“ç°äº† JS åœ¨è„šæœ¬é¢†åŸŸæ— äººèƒ½æ•Œçš„å¼ºå¤§æœ¬é¢†ã€‚</p>

<p>å…ˆæ¥çœ‹çœ‹ ğŸ‘‰ <a href="https://lab.roshanca.com/greedy-snake/">Demo</a>ã€‚</p>

<p>æ¥ä¸‹æ¥æ™’ä¸‹ä»£ç ï¼Œç„¶ååšä¸€äº›æ€è·¯è§£è¯»ï¼Œä»¥ä¾¿äºç†è§£å…¶åŸç†ã€‚</p>

<p>é¦–å…ˆç”¨ HTML å’Œ CSS å¸ƒç½®å¥½ç”»å¸ƒï¼ˆCanvasï¼‰:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Snake Game<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"./index.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">width=</span><span class="s">"400"</span> <span class="na">height=</span><span class="s">"400"</span><span class="nt">&gt;</span>Sorry, your browser does not support canvas<span class="nt">&lt;/canvas&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./index.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">body</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">justify-content</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="nl">align-items</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="m">100vh</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">canvas</span> <span class="p">{</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="no">black</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡ä»¥ä¸Šä»£ç æˆ‘ä»¬åœ¨é¡µé¢ä¸­å¤®å¼€è¾Ÿäº†ä¸€å— 400 Ã— 400 åƒç´ çš„é»‘åº•ç”»å¸ƒã€‚ä»¥ 20 Ã— 20 åšä¸ºä¸€ä¸ªåŸºæœ¬å•ä½ï¼Œå°†ç”»å¸ƒåˆ’åˆ†ä¸º 20 è¡Œ 20 åˆ—çš„æ–¹é˜µã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://s10.mogucdn.com/mlcdn/c45406/200520_6cbd63jcb3a6heed1a4chig2h77eg_1332x1324.png" alt=""></p>

<p>å¤§ä½“çš„æ€è·¯å°±æ˜¯ç”¨ç»¿è‰²æ¥å¡«å……è¿™äº›å°æ ¼å­æ¥è¡¨ç¤ºè›‡èº«ï¼Œç”¨é»„è‰²çš„ä¸€æ ¼æ¥ä»£è¡¨éšæœºå‡ºç°çš„é£Ÿç‰©ã€‚è›‡èº«è¦åŠ¨ï¼Œè¦æœ‰ä¸ªå®šæ—¶å™¨ï¼ŒæŒ‰ä¸€å®šçš„é¢‘ç‡å»æ›´æ–°ç”»å¸ƒã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** @type {HTMLCanvasElement} */</span>
<span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">canvas</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">box</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">2d</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">snake</span> <span class="o">=</span> <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="kd">let</span> <span class="nx">food</span> <span class="o">=</span> <span class="mi">43</span>
<span class="kd">let</span> <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">let</span> <span class="nx">n</span>

<span class="kd">const</span> <span class="nx">draw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">seat</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">box</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">color</span>
  <span class="nx">box</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">((</span><span class="nx">seat</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">~~</span><span class="p">(</span><span class="nx">seat</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">onkeydown</span> <span class="o">=</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">direction</span> <span class="o">=</span>
    <span class="nx">snake</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">][(</span><span class="nx">evt</span> <span class="o">||</span> <span class="nx">event</span><span class="p">).</span><span class="nx">keyCode</span> <span class="o">-</span> <span class="mi">37</span><span class="p">]</span> <span class="o">||</span> <span class="nx">direction</span><span class="p">)</span>
      <span class="p">?</span> <span class="nx">direction</span>
      <span class="p">:</span> <span class="nx">n</span>
<span class="p">}</span>

<span class="o">!</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">snake</span><span class="p">.</span><span class="nx">unshift</span><span class="p">((</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">direction</span><span class="p">))</span>

  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">snake</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">399</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">19</span><span class="p">)</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">GAME OVER!</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">draw</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="dl">'</span><span class="s1">lime</span><span class="dl">'</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="nx">food</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">snake</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">((</span><span class="nx">food</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">400</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">draw</span><span class="p">(</span><span class="nx">food</span><span class="p">,</span> <span class="dl">'</span><span class="s1">yellow</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">draw</span><span class="p">(</span><span class="nx">snake</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>é€šå¸¸è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ‹¿äºŒç»´æ•°ç»„æ¥ä»£è¡¨ä¸€ä¸ªç‚¹ï¼Œæˆ–ä¸€ä¸ªæ ¼å­ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">[0, 0]</code> å°±æ˜¯å·¦ä¸Šè§’ç¬¬ä¸€ä¸ªæ ¼å­ã€‚ä½†è¿™æ¬¡ä¸ä¸€æ ·ï¼Œä½œè€…æ˜¯æŒ‰ä»å·¦åˆ°å³ï¼Œè‡³ä¸Šè€Œä¸‹ï¼Œä¾æ¬¡æ¥æ ‡è®°è¿™äº›æ ¼å­çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ ‡è®°å‡ºäº† 0~399 ä¸ªæ ¼å­ã€‚</p>

<h2 id="ç”»è›‡ä¸æ·»è¶³">
<a class="anchor" href="#%E7%94%BB%E8%9B%87%E4%B8%8D%E6%B7%BB%E8%B6%B3" aria-hidden="true"><span class="octicon octicon-link"></span></a>ç”»è›‡ä¸æ·»è¶³</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">snake</span> <span class="o">=</span> <span class="p">[</span><span class="mi">41</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="kd">let</span> <span class="nx">food</span> <span class="o">=</span> <span class="mi">43</span>
<span class="kd">let</span> <span class="nx">direction</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">let</span> <span class="nx">n</span>
</code></pre></div></div>

<p>è›‡èº«ç”¨ä¸€ç»´æ•°ç»„æ¥è¡¨ç¤ºå³å¯ã€‚<code class="highlighter-rouge">food</code> ä»£è¡¨é£Ÿç‰©å‡ºç°çš„ä½ç½®ï¼Œ<code class="highlighter-rouge">direction</code> è¡¨ç¤ºè›‡å¤´ä¸‹ä¸€æ¬¡è¿åŠ¨çš„è½¬å‘ä½ç§»é‡ã€‚æœ€æœ‰æ„æ€çš„æ˜¯è¿™ä¸ª <code class="highlighter-rouge">n</code>ï¼Œå®ƒæ˜¯ç”¨æ¥è®°å½•è›‡èº«å•ä½æ—¶é—´å†…çš„ç§»åŠ¨ä½ç§»ï¼Œä¹Ÿå°±æ˜¯è›‡è¿åŠ¨åŠ¨ç”»å½“å‰å¸§çš„ç»˜åˆ¶ç›®æ ‡æ ¼å­ã€‚çœ‹åˆ°è¿™ä¸€è¡Œï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">snake</span><span class="p">.</span><span class="nx">unshift</span><span class="p">((</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">direction</span><span class="p">))</span>
</code></pre></div></div>

<p>è¿™é‡Œæ˜¯ä¸¤æ­¥æ“ä½œï¼š</p>

<ol>
  <li>å…ˆå°†è›‡å¤´æ ¹æ®æ–¹å‘è½¬å‘è·å–åˆ°ä¸‹ä¸€æ­¥çš„ä½ç§»é‡ï¼Œèµ‹å€¼ç»™ <code class="highlighter-rouge">n</code>;</li>
  <li>è›‡èº«æŠŠä¸‹ä¸€æ­¥çš„ä½ç§» <code class="highlighter-rouge">n</code> åšä¸ºæ–°çš„è›‡å¤´ï¼ŒåŠ å…¥åˆ°ä¸€ç»´æ•°ç»„é‡Œã€‚</li>
</ol>

<p>è¿™é‡Œè¿˜æ¯”è¾ƒå¥½ç†è§£ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥çœ‹åˆ°å¦‚ä½•åœ¨ canvas ä¸Šç”»æ ¼å­ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">draw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">seat</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">box</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">color</span>
  <span class="nx">box</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">((</span><span class="nx">seat</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">~~</span><span class="p">(</span><span class="nx">seat</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">draw</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="dl">'</span><span class="s1">lime</span><span class="dl">'</span><span class="p">)</span>
</code></pre></div></div>

<p>æ ¹æ® 20 Ã— 20 çš„åˆ’åˆ†æ ‡è®°ï¼Œæˆ‘ä»¬é€šè¿‡ <code class="highlighter-rouge">seat / 20</code> å–æ•´æ¥å¾—åˆ°è¡Œï¼Œ<code class="highlighter-rouge">seat % 20</code> æ¥è·å¾—åˆ—ã€‚è¡Œå’Œåˆ—åº”è¯¥éƒ½æ˜¯ 0~19 ä¹‹é—´çš„æ•´æ•°ã€‚å¦‚æœç”¨ <code class="highlighter-rouge">row</code> å’Œ <code class="highlighter-rouge">col</code> åˆ†åˆ«è¡¨ç¤ºå…¶è¡Œå’Œåˆ—çš„ç»“æœï¼ŒæŒ‰é“ç†åº”è¯¥æ˜¯è¿™èˆ¬ç»˜åˆ¶ï¼š<code class="highlighter-rouge">box.fillRect(col * 20, row * 20, 20, 20)</code>â€”â€”è¿™æ˜¯ç”»æ»¡æ ¼çš„æƒ…å†µã€‚ç•™ä¸ªä¸€åƒç´ çš„å†…è¾¹è·ï¼Œå°±æ˜¯åŸç¤ºä¾‹ä¸­çš„å†™æ³•ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="nx">food</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">draw</span><span class="p">(</span><span class="nx">snake</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span> <span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åç»­ <code class="highlighter-rouge">n == food</code> æ—¶è¡¨ç¤ºè›‡åƒåˆ°é£Ÿç‰©ï¼Œé‚£å°±è¿›å…¥åˆ°å†éšæœºç”Ÿæˆé£Ÿç‰©çš„é€»è¾‘ã€‚ç»“åˆ else çš„é€»è¾‘ï¼Œé€šç¯‡çœ‹ä¸‹æ¥ç°åœ¨æˆ‘ä»¬å¯ä»¥æŠŠåœ¨ä¸€å¸§å†…çš„è›‡èº«æ“ä½œæ”¾åœ¨ä¸€èµ·çœ‹äº†ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// next step</span>
<span class="nx">n</span> <span class="o">=</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">direction</span>

<span class="c1">// append head</span>
<span class="nx">snake</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>

<span class="c1">// cut off tail</span>
<span class="nx">snake</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="direction">
<a class="anchor" href="#direction" aria-hidden="true"><span class="octicon octicon-link"></span></a>direction</h2>

<p><code class="highlighter-rouge">direction</code> çš„è®¡ç®—ä¹Ÿé¢‡ä¸ºå·§å¦™ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">onkeydown</span> <span class="o">=</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">direction</span> <span class="o">=</span>
    <span class="nx">snake</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">][(</span><span class="nx">evt</span> <span class="o">||</span> <span class="nx">event</span><span class="p">).</span><span class="nx">keyCode</span> <span class="o">-</span> <span class="mi">37</span><span class="p">]</span> <span class="o">||</span> <span class="nx">direction</span><span class="p">)</span>
      <span class="p">?</span> <span class="nx">direction</span>
      <span class="p">:</span> <span class="nx">n</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ•°ç»„ <code class="highlighter-rouge">[-1, -20, 1, 20]</code> åšä¸ºå››ä¸ªæ–¹å‘çš„ä½ç§»é‡<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>ï¼Œè€Œ <code class="highlighter-rouge">(evt || event).keyCode - 37</code> åšä¸ºå…¶ç´¢å¼•å€¼ï¼ŒæŒ‰ä¸åŒæ–¹å‘é”®å¯ä»¥å–åˆ°å…¶å¯¹åº”çš„åç§»é‡ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">][(</span><span class="nx">evt</span> <span class="o">||</span> <span class="nx">event</span><span class="p">).</span><span class="nx">keyCode</span> <span class="o">-</span> <span class="mi">37</span><span class="p">]</span> <span class="o">||</span> <span class="nx">direction</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„å·§å¦™ä¹‹å¤„åœ¨äº<strong>å¦‚æœæŒ‰ä¸‹çš„æŒ‰é”®ä¸æ˜¯æ–¹å‘é”®ï¼Œåœ¨æ•°ç»„ä¸­å°†å¾—ä¸åˆ°å¯¹åº”çš„å€¼</strong>ã€‚æ‰€ä»¥ <code class="highlighter-rouge">...|| direction</code> è¿™æ­¥æ“ä½œï¼Œå¯ä»¥ä½¿å¾— <code class="highlighter-rouge">n</code> å–åˆ°åŸæ¥ <code class="highlighter-rouge">direction</code> çš„å€¼ï¼Œè€Œä¸æ˜¯ <code class="highlighter-rouge">undefined</code>ã€‚æ‰€ä»¥æ­¤æ—¶ <code class="highlighter-rouge">n</code> çš„å–å€¼ï¼Œè¦ä¹ˆæ˜¯æ•°ç»„ <code class="highlighter-rouge">[-1, -20, 1, 20]</code> ä¸­çš„æŸä¸ªå€¼ï¼Œè¦ä¹ˆå°±æ˜¯å‰ä¸€ä¸ª <code class="highlighter-rouge">direction</code> çš„å€¼ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">snake</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">...</span> <span class="p">?</span> <span class="nx">direction</span> <span class="p">:</span> <span class="nx">n</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å·²ç»èƒ½å¾ˆå®Œç¾åœ°æ‹¿åˆ° <code class="highlighter-rouge">n</code> çš„å€¼äº†ï¼Œé‚£ä¸Šé¢çš„è¿™ä¸ªä¸‰å…ƒåˆ¤æ–­åˆæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é˜²åè½¬ã€‚å°±æ˜¯å½“æŒ‰é”®æ–¹å‘ä¸è›‡è¿åŠ¨æ–¹å‘ç›¸åæ—¶ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªåˆ¤æ–­çš„è¯ï¼Œå°±ä¼šé”™ä¹±ã€‚<code class="highlighter-rouge">snake[1] - snake[0]</code> å¯è§†ä¸ºå½“å‰çš„åæ–¹å‘ï¼Œå³ <code class="highlighter-rouge">-direction</code>ï¼Œå¦‚æœæ­¤æ—¶ <code class="highlighter-rouge">n</code> çœŸçš„å–å€¼ä¸º <code class="highlighter-rouge">-direction</code>ï¼Œåˆ™éœ€å°†å…¶çŸ«æ­£ä¸º <code class="highlighter-rouge">direction</code>ã€‚</p>

<h2 id="æ¡ä»¶åˆ¤æ–­">
<a class="anchor" href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD" aria-hidden="true"><span class="octicon octicon-link"></span></a>æ¡ä»¶åˆ¤æ–­</h2>

<p>å¥½äº†ï¼Œå…¶å®ƒå°±è¾ƒä¸ºç®€å•äº†ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// GAME OVER çš„åˆ¤æ–­æ¡ä»¶</span>

<span class="k">if</span> <span class="p">(</span>
  <span class="c1">// è›‡å¤´ç¢°åˆ°è‡ªèº«</span>
  <span class="nx">snake</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
  <span class="c1">// ç¢°åˆ°ä¸Šè¾¹ç•Œ</span>
  <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
  <span class="c1">// ç¢°åˆ°ä¸‹è¾¹ç•Œ</span>
  <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">399</span> <span class="o">||</span>
  <span class="c1">// ç¢°åˆ°å³è¾¹ç•Œ</span>
  <span class="p">(</span><span class="nx">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
  <span class="c1">// ç¢°åˆ°å·¦è¾¹ç•Œ</span>
  <span class="p">(</span><span class="nx">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">19</span><span class="p">)</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">GAME OVER!</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="nx">snake</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">((</span><span class="nx">food</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">400</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// è¿™å¥å¯ç¿»è¯‘ä¸º</span>
<span class="k">do</span> <span class="p">{</span>
  <span class="nx">food</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">400</span><span class="p">)</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">snake</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">food</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨éšæœºç”Ÿæˆ food ä½ç½®çš„åŒæ—¶ï¼Œä¹Ÿé¿å…äº†ç”Ÿæˆä½ä¸è›‡èº«é‡åˆçš„é—®é¢˜ã€‚</p>

<h2 id="iife">
<a class="anchor" href="#iife" aria-hidden="true"><span class="octicon octicon-link"></span></a>IIFE</h2>

<p>çœ‹åˆ°æœ€åä¸€éƒ¨åˆ†ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>è¿™æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆIIFEï¼‰ï¼Œè¿™é‡Œæœ‰<a href="/2012/traps-in-javascript-part-I#%E5%9D%91%E4%BA%94%E5%87%BD%E6%95%B0%E7%9A%84%E8%87%AA%E6%89%A7%E8%A1%8C">ä»‹ç»</a>ã€‚</p>

<p>é¡ºä¾¿æä¸€ä¸‹å…¶ä¸­çš„ <code class="highlighter-rouge">arguments.callee</code>ï¼ŒæŒ‡çš„æ˜¯ï¼š</p>

<blockquote>
  <p>å¼•ç”¨å‚æ•°æ‰€å±çš„å½“å‰æ‰§è¡Œå‡½æ•° â€”â€” <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments">MDN web docs</a></p>
</blockquote>

<p>æ‰€ä»¥è¿™é‡Œ <code class="highlighter-rouge">setTimeout</code> å°±èƒ½è®©è¿™æ®µå‡½æ•°ä¸åœåœ°æ‰§è¡Œä¸‹å»ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¢ä½œ <code class="highlighter-rouge">setInterval</code> æ¥å®ç°ã€‚</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>åˆ†åˆ«ä¸ºï¼šå·¦ã€ä¸Šã€å³ã€ä¸‹ã€‚Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">â†©</a></p>
    </li>
  </ol>
</div>

    </section>
    <hr>
    <footer class="post-footer">
      <div class="post-meta">
        <a href="/2020/Implement-a-minimalist-greedy-snake-with-canvas/" rel="full-article"><time datetime="2020-05-20 15:43:09 +0000" pubdate>May 20, 2020</time></a>

        
<span class="post-tag">
  
  <a class="tag" href="/archives/tag/javascript">javascript</a>
  
  <a class="tag" href="/archives/tag/canvas">canvas</a>
  
  <a class="tag" href="/archives/tag/game">game</a>
  
</span>


      </div>
    </footer>
    <section class="post-recent">
  
  <a class="relative-post previous" href="/2018/format-financial-currency-number/"
    ><span>å¯¹æ•°å­—çš„é‡‘èè´§å¸æ ¼å¼åŒ–</span></a
  >
   
  <a class="relative-post next" href="/2020/performance-indicators/"
    ><span>é¡µé¢æ€§èƒ½(W3C)æŒ‡æ ‡è¯´æ˜åŠå®šä¹‰</span></a
  >
  
</section>

  </article>
  
</main>

  <footer id="footer" role="contentinfo">
  <p>
    Â© Copyright 2012 -
  </p>
</footer>

<script src="/assets/scripts/anchor.min.js"></script>
<script src="/assets/scripts/toc.js"></script>

<script src="/assets/scripts/common.js"></script>

</div>
</body>
</html>